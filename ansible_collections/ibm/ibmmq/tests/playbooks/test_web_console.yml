---
- name: Test downloading and installing MQ
  hosts: all
  become: false
  environment:
    PATH: /opt/mqm/bin:{{ ansible_env.PATH }}

  roles:
    - setupconsole
    - startconsole

  tasks:
    - name: Get mqwebuser
      stat:
        path: /var/mqm/web/installations/Installation1/servers/mqweb/mqwebuser.xml
      register: testout_mqwebuser

    - name: Test new mqwebuser exists
      assert:
        that:
          - testout_mqwebuser.stat.exists

    - name: Print mqwebuser
      debug:
        msg: testout_mqwebuser.stat.pw_name

    - name: Test mqwebuser has correct permissions
      assert:
        that:
          - '{{ testout_mqwebuser.stat.mode }} == "0640"'

    - name: Test ansible user is owner of mqwebuser
      assert:
        that:
          - "{{ testout_mqwebuser.stat.pw_name }} == {{ ansible_ssh_user }}"

    - name: Display web console status
      command: dspmqweb status
      register: testout_webconsole_status
      changed_when: false

    - name: Test mq web console is running
      assert:
        that:
          - '{{ testout_webconsole_status.stdout_lines }} is search("is running")'
